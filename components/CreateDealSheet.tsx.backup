import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useMutateAction, useLoadAction } from '@quibakery/data';
import { TrendingUp, Flag, FileText, Paperclip, X, User, Loader2 } from 'lucide-react';
import { useState, useEffect } from 'react';
import loadContactsAction from '@actions/loadContacts';
import { uploadFiles, formatFileSize } from '@lib/storage';
import { useMockData } from '@lib/supabase';
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from '@components/ui/sheet';
import {
  Form,
  FormField,
  FormItem,
  FormLabel,
  FormControl,
  FormMessage,
} from '@components/ui/form';
import { Input } from '@components/ui/input';
import { Textarea } from '@components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@components/ui/select';
import { Button } from '@components/ui/button';
import createDealAction from '@actions/createDeal';

/*
 * Schema for creating a deal. Name, use case, and description are required.
 * Contact and stage are optional with defaults.
 * Signal is auto-determined by AI - not user editable.
 */
const dealSchema = z.object({
  contactId: z.any().optional(), // Accept any type for contactId - we'll convert it later
  name: z.string().min(1, { message: 'Deal name is required' }),
  useCase: z.string().min(1, { message: 'Use case is required' }),
  description: z.string().min(1, { message: 'Description is required' }),
  stage: z.enum(['new', 'qualified', 'negotiating', 'closed_won', 'closed_lost']).default('new'),
});

export type CreateDealData = z.infer<typeof dealSchema>;

type Props = {
  contactId?: string;
  open: boolean;
  onClose: () => void;
  onSuccess: (dealId: string) => void;
};

/**
 * Sliding sheet component for creating a new deal. Can be linked to a contact or standalone.
 * Presents a form with fields for contact, name, use case, description, and stage.
 * Signal is auto-determined by AI after deal creation.
 */
export default function CreateDealSheet({ contactId, open, onClose, onSuccess }: Props) {
  console.log('CreateDealSheet rendered - open:', open);
  
  const [attachments, setAttachments] = useState<File[]>([]);
  const [uploading, setUploading] = useState(false);
  
  // Load contacts for selector
  const { data: contacts, loading: loadingContacts } = useLoadAction(loadContactsAction, [], {});
  
  const form = useForm<CreateDealData>({
    resolver: zodResolver(dealSchema),
    defaultValues: {
      contactId: contactId || '',
      name: '',
      useCase: '',
      description: '',
      stage: 'new',
    },
  });
  const { control, handleSubmit, reset, formState } = form;
  const { errors } = formState;
  
  // KEY FIX: Sync contactId prop changes to form state with proper type conversion
  useEffect(() => {
    if (open) {
      // When sheet opens, ensure contactId is properly set as a string
      form.setValue('contactId', contactId || '');
    }
  }, [contactId, open, form]);
  
  // Log form errors for debugging
  useEffect(() => {
    if (Object.keys(errors).length > 0) {
      console.log('‚ùå Form validation errors:', errors);
    }
  }, [errors]);

  const [createDeal, { isLoading: isSubmitting }] = useMutateAction(createDealAction);
  
  console.log('üí° CreateDeal function:', typeof createDeal, 'isSubmitting:', isSubmitting);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const newFiles = Array.from(e.target.files);
      setAttachments(prev => [...prev, ...newFiles]);
    }
  };

  const removeAttachment = (index: number) => {
    setAttachments(prev => prev.filter((_, i) => i !== index));
  };

  const onSubmit = async (data: CreateDealData) => {
    try {
      console.log('üöÄ onSubmit function called!');
      console.log('Form data received:', data);
      
      setUploading(true);
      
      console.log('=== Starting deal creation ===');
      
      // First create the deal to get the ID
      const result = await createDeal({
        contact_id: data.contactId || null,
        name: data.name,
        use_case: data.useCase,
        stage: data.stage,
        signal: 'neutral', // Default signal - AI will update this
        description: data.description,
        attachments: null, // Will update after upload
      });
      
      console.log('createDeal result:', result);
      
      const newId = result && result[0] ? result[0].id : '';
      
      if (!newId) {
        throw new Error('Failed to get deal ID from result');
      }
      
      console.log('New deal ID:', newId);
      
      // Upload files to storage if not in mock mode
      let uploadedAttachments = null;
      if (attachments.length > 0 && !useMockData) {
        try {
          console.log('Uploading files to Supabase Storage...');
          uploadedAttachments = await uploadFiles(attachments, newId);
          console.log('Files uploaded:', uploadedAttachments);
          
          // Update the deal with attachment URLs
          // You could create an updateDeal action here if needed
        } catch (uploadError) {
          console.error('Error uploading files:', uploadError);
          // Continue even if upload fails
        }
      } else if (attachments.length > 0 && useMockData) {
        // In mock mode, just store file metadata without uploading
        uploadedAttachments = attachments.map(f => ({
          name: f.name,
          url: `mock://file/${f.name}`,
          size: f.size,
          type: f.type,
        }));
      }
      
      console.log('=== Deal creation successful ===');
      onSuccess(newId);
      reset();
      setAttachments([]);
      onClose();
    } catch (error) {
      console.error('!!! Error creating deal:', error);
      alert(`Failed to create deal: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setUploading(false);
    }
  };

  return (
    <Sheet open={open} onOpenChange={(v: boolean) => !v && onClose()}>
      <SheetContent>
        <SheetHeader className="space-y-3 border-gray-100">
          <SheetTitle className="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
            Create New Deal
          </SheetTitle>
          <SheetDescription className="text-base">
            Enter deal information for this contact.
          </SheetDescription>
        </SheetHeader>
        
        <div className="flex-1 overflow-y-auto px-8 py-6">
          <Form {...form}>
            {/* Using div instead of form to avoid browser form submission */}
            <div className="space-y-6">
              {/* Contact Selector */}
              <FormField
                control={control}
                name="contactId"
                render={({ field }: any) => (
                  <FormItem>
                    <FormLabel className="text-sm font-semibold text-gray-700">
                      Contact
                    </FormLabel>
                    <FormControl>
                      <div className="relative">
                        <User className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 z-10" />
                        <Select
                          value={field.value}
                          onValueChange={field.onChange}
                          disabled={loadingContacts}
                        >
                          <SelectTrigger className="h-11 pl-10 border-gray-300 focus:border-green-500 focus:ring-green-500">
                            <SelectValue placeholder="Select a contact (optional)" />
                          </SelectTrigger>
                          <SelectContent>
                            {contacts?.map((contact: any) => (
                              <SelectItem key={contact.id} value={contact.id}>
                                {contact.first_name} {contact.last_name} ({contact.company})
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              {/* Deal Name */}
              <FormField
                control={control}
                name="name"
                render={({ field }: any) => (
                  <FormItem>
                    <FormLabel className="text-sm font-semibold text-gray-700">
                      Deal Name <span className="text-red-500">*</span>
                    </FormLabel>
                    <FormControl>
                      <div className="relative">
                        <TrendingUp className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input 
                          placeholder="Enterprise License Agreement" 
                          className="pl-10 h-11 border-gray-300 focus:border-green-500 focus:ring-green-500" 
                          {...field} 
                        />
                      </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              {/* Use Case */}
              <FormField
                control={control}
                name="useCase"
                render={({ field }: any) => (
                  <FormItem>
                    <FormLabel className="text-sm font-semibold text-gray-700">
                      Use Case <span className="text-red-500">*</span>
                    </FormLabel>
                    <FormControl>
                      <Input 
                        placeholder="Data Analytics Platform" 
                        className="h-11 border-gray-300 focus:border-green-500 focus:ring-green-500" 
                        {...field} 
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              {/* Stage and Signal - Side by Side */}
              <div className="grid grid-cols-2 gap-4">
                {/* Stage */}
                <FormField
                  control={control}
                  name="stage"
                  render={({ field }: any) => (
                    <FormItem>
                      <FormLabel className="text-sm font-semibold text-gray-700">Stage</FormLabel>
                      <FormControl>
                        <Select
                          value={field.value}
                          onValueChange={(value: string) => field.onChange(value as CreateDealData['stage'])}
                        >
                          <SelectTrigger className="h-11 border-gray-300 focus:border-green-500 focus:ring-green-500">
                            <SelectValue placeholder="Select stage" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="new">üÜï New</SelectItem>
                            <SelectItem value="qualified">‚úÖ Qualified</SelectItem>
                            <SelectItem value="negotiating">üí¨ Negotiating</SelectItem>
                            <SelectItem value="closed_won">üéâ Closed Won</SelectItem>
                            <SelectItem value="closed_lost">‚ùå Closed Lost</SelectItem>
                          </SelectContent>
                        </Select>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                {/* Signal */}
                <FormField
                  control={control}
                  name="signal"
                  render={({ field }: any) => (
                    <FormItem>
                      <FormLabel className="text-sm font-semibold text-gray-700">Signal</FormLabel>
                      <FormControl>
                        <div className="relative">
                          <Flag className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 z-10" />
                          <Select
                            value={field.value}
                            onValueChange={(value: string) => field.onChange(value as CreateDealData['signal'])}
                          >
                            <SelectTrigger className="h-11 pl-10 border-gray-300 focus:border-green-500 focus:ring-green-500">
                              <SelectValue placeholder="Select signal" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="positive">üü¢ Positive</SelectItem>
                              <SelectItem value="neutral">üü° Neutral</SelectItem>
                              <SelectItem value="negative">ÔøΩ Negative</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
              
              {/* Description */}
              <FormField
                control={control}
                name="description"
                render={({ field }: any) => (
                  <FormItem>
                    <FormLabel className="text-sm font-semibold text-gray-700">
                      Description <span className="text-red-500">*</span>
                    </FormLabel>
                    <FormControl>
                      <div className="relative">
                        <FileText className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                        <Textarea 
                          placeholder="Describe the deal and key details..." 
                          className="pl-10 min-h-[100px] border-gray-300 focus:border-green-500 focus:ring-green-500" 
                          {...field} 
                        />
                      </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              {/* Attachments */}
              <div className="space-y-3">
                <FormLabel className="text-sm font-semibold text-gray-700">
                  <Paperclip className="inline h-4 w-4 mr-1" />
                  Attachments
                </FormLabel>
                
                <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-green-400 transition-colors">
                  <label className="flex flex-col items-center justify-center cursor-pointer">
                    <input
                      type="file"
                      multiple
                      onChange={handleFileChange}
                      className="hidden"
                      accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.png,.jpg,.jpeg"
                    />
                    <Paperclip className="h-8 w-8 text-gray-400 mb-2" />
                    <span className="text-sm text-gray-600 font-medium">
                      Click to upload files
                    </span>
                    <span className="text-xs text-gray-500 mt-1">
                      PDF, DOC, XLS, images (Max 10MB each)
                    </span>
                  </label>
                </div>
                
                {/* Attachment List */}
                {attachments.length > 0 && (
                  <div className="space-y-2">
                    {attachments.map((file, index) => (
                      <div 
                        key={index} 
                        className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200"
                      >
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                          <Paperclip className="h-4 w-4 text-gray-500 flex-shrink-0" />
                          <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium text-gray-700 truncate">
                              {file.name}
                            </p>
                            <p className="text-xs text-gray-500">
                              {formatFileSize(file.size)}
                            </p>
                          </div>
                        </div>
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => removeAttachment(index)}
                          className="flex-shrink-0 h-8 w-8 p-0 hover:bg-red-50 hover:text-red-600"
                        >
                          <X className="h-4 w-4" />
                        </Button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              
              {/* Buttons */}
              <div className="flex gap-3 pt-4 border-t border-gray-100">
                <Button 
                  type="button"
                  onClick={async (e: React.MouseEvent<HTMLButtonElement>) => {
                    try {
                      e.preventDefault();
                      e.stopPropagation();
                      
                      console.log('üî• Button clicked - starting manual validation');
                      
                      // Trigger validation
                      const isValid = await form.trigger();
                      console.log('Form validation result:', isValid);
                      
                      if (!isValid) {
                        console.log('‚ùå Validation failed:', form.formState.errors);
                        alert('Please fill in all required fields');
                        return;
                      }
                      
                      // Get form values and ensure proper types
                      const formData = form.getValues();
                      console.log('Form data:', formData);
                      
                      // Convert contactId to string if it exists
                      const cleanedData: CreateDealData = {
                        ...formData,
                        contactId: formData.contactId ? String(formData.contactId) : undefined,
                      };
                      
                      console.log('Cleaned data:', cleanedData);
                      console.log('ContactId type:', typeof cleanedData.contactId);
                      console.log('ContactId value:', cleanedData.contactId);
                      
                      // Call onSubmit
                      await onSubmit(cleanedData);
                    } catch (error) {
                      console.error('Button click error:', error);
                      alert('Error: ' + (error instanceof Error ? error.message : 'Unknown error'));
                    }
                  }}
                  disabled={isSubmitting || uploading} 
                  className="flex-1 h-11 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold shadow-lg"
                >
                  {uploading ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Uploading files...
                    </>
                  ) : isSubmitting ? (
                    'Creating...'
                  ) : (
                    'Create Deal'
                  )}
                </Button>
                <Button 
                  type="button" 
                  variant="outline" 
                  onClick={onClose} 
                  disabled={isSubmitting || uploading}
                  className="px-6 h-11 border-gray-300 hover:bg-gray-50"
                >
                  Cancel
                </Button>
              </div>
            </div>
          </Form>
        </div>
      </SheetContent>
    </Sheet>
  );
}